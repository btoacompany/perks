<div class="time_line_wrapper">
<div id="wrapper">
<div id="contents">
<% if flash[:notice] %><p class="c_align notice" style="color: red;"><b><i><%= flash[:notice] %></i></b></p><% end %>
<div style="text-align:center"><b><i><span class="notice"></span></i></b></div><br>
  <div class="mypage row">
    <% if @banner %>
      <%= image_tag @banner.img_src ,class: "width-100-percent" %>
    <% else %>
      <img src="https://btoa-img.s3-ap-northeast-1.amazonaws.com/company/banner_no_image" class="width-100-percent" />
    <% end %>
    <div class="mypage row">
      <div class="rightbox col-4" >
        <div class="title"> 今週、<%= @receiver_ratio[0] %>回「ありがとう」をもらっています！</div>
        <div class="profilebox">
          <div class="user_stats" style="text-align: center; padding: 20px 10px 5px 10px;">
          <% if @receiver_ratio[1] == "-" %>
            <span style="color: #ff8d07; font-size: 40px"><b><%= number_to_percentage(@receiver_ratio[1], precision: 0) %></b></span><span style="color: red; font-size: 40px; font-weight: 900"><b></b></span><span style="font-size: 12px; color: #808080"><br><br>翌週から結果を表示します！</span>
          <% elsif @receiver_ratio[1] > 0 %>
            <span style="color: #ff8d07; font-size: 40px"><b><%= number_to_percentage(@receiver_ratio[1], precision: 0) %></b></span><span style="color: red; font-size: 40px; font-weight: 900"><b>↑</b></span><span style="font-size: 12px; color: #808080"><br><br>先週よりも褒められています！</span>
          <% elsif @receiver_ratio[1] == 0 %>
            <span style="color: #ff8d07; font-size: 40px"><b><%= number_to_percentage(@receiver_ratio[1], precision: 0) %></b></span><span style="font-size: 12px; color: #808080"><br><br>先週比アップを狙いましょう！</span>
          <% else %>
            <span style="color: #2d87e2; font-size: 36px"><b><%= number_to_percentage(@receiver_ratio[1], precision: 0) %></b></span><span style="color: blue; font-size: 40px; font-weight: 900"><b>↓</b></span><span style="font-size: 12px; color: #808080"><br><br>先週に比べマイナスになっています><</span>
          <% end %>
        </div>
      </div><br>
      <div class="title"> 今週、<%= @giver_ratio[0] %>回「ありがとう」を伝えています！</div>
        <div class="profilebox">
          <div class="user_stats" style="text-align: center; padding: 20px 10px 5px 10px;">
            <% if @giver_ratio[1] == "-" %>
              <span style="color: #ff8d07; font-size: 40px"><b><%= number_to_percentage(@giver_ratio[1], precision: 0) %></b></span><span style="color: red; font-size: 40px; font-weight: 900"><b></b></span><span style="font-size: 12px; color: #808080"><br><br>翌週から結果を表示します！</span>
            <% elsif @giver_ratio[1] > 0 %>
              <span style="color: #ff8d07; font-size: 40px"><b><%= number_to_percentage(@giver_ratio[1], precision: 0) %></b></span><span style="color: red; font-size: 40px; font-weight: 900"><b>↑</b></span><span style="font-size: 12px; color: #808080"><br><br>先週よりも感謝を伝えています！</span>
            <% elsif @giver_ratio[1] == 0 %>
              <span style="color: #ff8d07; font-size: 40px"><b><%= number_to_percentage(@giver_ratio[1], precision: 0) %></b></span><span style="font-size: 12px; color: #808080"><br><br>先週比アップを狙いましょう！</span>
            <% else %>
              <span style="color: #2d87e2; font-size: 36px"><b><%= number_to_percentage(@giver_ratio[1], precision: 0) %></b></span><span style="color: blue; font-size: 40px; font-weight: 900"><b>↓</b></span><span style="font-size: 12px; color: #808080"><br><br>先週に比べマイナスになっています><</span>
            <% end %>
          </div>
        </div><br>
      </div>
    <div class="leftbox col-8" style="padding-left:0;">
      <div class="clearfix width-100-percent">
      <%= link_to profile_articles_path, :class => "article_box" do %>
        ニュース<br/>トピック
      <% end %>
      <%= link_to "/profile", :class => "receiving_box" do %>
        もらったメッセージ<br/>を見る
      <% end %>
      <%= link_to "/profile/given", :class => "giving_box bkgc_white" do %>
        贈ったメッセージ<br/>を見る
      <% end %>
      <%= link_to "/rewards/status", :class => "present_box" do %>
        メッセージ<br/>を贈る
      <% end %>
      </div>
    <div class="timeline">
      <div class="pagination" style="float:right">
        <% if @total_pages > 8 %>
          <% unless @page_now == 1 %>
            <a href="<%= "#{@prizy_url}/profile/given/?page=1" %>">最初</a>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{@previous_page}" %>">前へ</a>
          <% end %>
          <a href="<%= "#{@prizy_url}/profile/given/?page=#{@page_now}" %>"><%= @page_now %></a>
          <% unless @page_now == @total_pages %>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{@next_page}" %>">次へ</a>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{@total_pages}" %>">最後</a>
          <% end %>
        <% else %>
          <% (1..@total_pages).each do | i | %>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{i}" %>"><%= i %></a>
          <% end %>
        <% end %>
      </div><br>
      <div class="clearfix"></div>
      <%= render 'bottomprofile' %>
      <div class="pagination" style="float:right">
        <% if @total_pages > 8 %>
          <% unless @page_now == 1 %>
            <a href="<%= "#{@prizy_url}/profile/given/?page=1" %>">最初</a>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{@previous_page}" %>">前へ</a>
          <% end %>
          <a href="<%= "#{@prizy_url}/profile/given/?page=#{@page_now}" %>"><%= @page_now %></a>
          <% unless @page_now == @total_pages %>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{@next_page}" %>">次へ</a>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{@total_pages}" %>">最後</a>
          <% end %>
        <% else %>
          <% (1..@total_pages).each do | i | %>
            <a href="<%= "#{@prizy_url}/profile/given/?page=#{i}" %>"><%= i %></a>
          <% end %>
        <% end %>
      </div><br>
      <div class="clearfix"></div>
    </div><!-- timeline -->
    </div>

    </div>
  </div><!-- row -->
</div> <!-- contents -->
</div> <!-- wrapper -->
</div>

<script type="text/javascript">
$(".btn_edit").click(function() {
  window.location = '/update';
});
</script>

<script type="text/javascript">
$(".btn_edit").click(function() {
  window.location = '/update';
});
</script>

<script type="text/javascript">
$.urlParam = function(name){
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results != null) {
    return results[1];
  } else {
    return 0;
  }
}

$(".give_comments").bind('keypress',function(e) {
  if(e.keyCode == 13) {
    var post_id = ($(this).attr('data-id')); //get attributes of clicked item
    var comments = ($(this).val()); //get attributes of clicked item

    postComment(post_id, comments);
  }
});

$(".btn_comment").click(function() {
  var post_id = ($(this).attr('data-id')); //get attributes of clicked item
  var comments = $(".post_comment_"+post_id).val(); 

  postComment(post_id, comments);
});

function postComment(post_id, comments) {
  $.ajax({
    type: "POST",
    url: "/user/give_comments",
    data: { 'post_id': post_id, 'comments': comments, 'page': $.urlParam('page') },
    success: function(data) {
      $(this).val("");
      window.location.reload(); 
    }
  });
}

$(".btn_like").mouseup(function() {
  var post_id = ($(this).attr('data-id')); //get attributes of clicked item

  $.ajax({
    type: "POST",
    url: "/user/give_kudos",
    data: { 'post_id': post_id, 'kudos': 1 },
    success: function(data) {
      window.location.reload(); 
    }
  });
});

$(".btn_unlike").mouseup(function() {
  var post_id = ($(this).attr('data-id')); //get attributes of clicked item

  $.ajax({
    type: "POST",
    url: "/user/give_kudos",
    data: { 'post_id': post_id, 'kudos': 0 },
    success: function(data) {
      window.location.reload(); 
    }
  });
});

function getTag () {
  items = [];
  <% if @hashtags.present? %>
    <% @hashtags.each do | tag | %>
      items.push("<%= tag %>");
    <% end %>
  <% end %>
  return items;
}

function getName () {
  items = {};
  <% if @users.present? %>
    <% @users.each do | user | %>
      <% unless user.id == @user.id %> 
  items["<%= user.id %>"] = "<%= user.name %>";
      <% end %>
    <% end %>
  <% end %>
  return items;
}


$(document).ready(function() {
  $(".time p").each(function() {
    $(this).html(timeSince($(this).html()));
  });
});

function timeSince(time) {
  var currentTime = new Date();
  var time = new Date(time);

  var seconds = Math.floor((currentTime - time)/1000);
  var interval = Math.floor(seconds / 31536000);

  if (interval >= 1) {
      return interval + "年前";
  }
  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) {
      return interval + "月前";
  }
  interval = Math.floor(seconds / 86400);
  if (interval >= 1) {
      return interval + "日前";
  }
  interval = Math.floor(seconds / 3600);
  if (interval >= 1) {
      return interval + "時間前";
  }
  interval = Math.floor(seconds / 60);
  if (interval >= 1) {
      return interval + "分前";
  }
  return Math.floor(seconds) + "秒前";
}
$('.del_comment').click(function() {
  var _id = ($(this).attr('data-id')); //get attributes of clicked item

  if (confirm("本当にこのコメントを削除しますか？")) {
    $.post("/user/delete_comment", { 'comment_id': _id }); //send post request
    $(".comment_" + _id).remove(); //remove item upon deletion
  }
  return false; //do nothing
});

$('.del_post').click(function() {
  var _id = ($(this).attr('data-id')); //get attributes of clicked item

  if (confirm("本当にこの投稿を削除しますか？")) {
    $.post("/user/delete_post", { 'post_id': _id }); //send post request
    $(".post_" + _id).remove(); //remove item upon deletion
  }
  return false; //do nothing
});
$(window).click(function() {
  $(".editnav .dropdown_content").hide();
});
$("#wrapper").click(function(event) {
  event.stopPropagation();
});
</script>
